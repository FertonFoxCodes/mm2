-- Safe MM2-style UI + Autofarm (LocalScript)
-- No HttpGet, no loadstring, no remote :Fire/:Invoke, no require(server modules)
-- Place in StarterPlayer > StarterPlayerScripts (or run as a LocalScript)

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local Humanoid = Character:WaitForChild("Humanoid")

-- ===== CONFIG =====
local AUTO_FARM_SPEED = 15 -- default movement speed for tween (keep conservative; anti-cheat may detect high speeds)
local MAX_SAFE_SPEED = 22 -- UI caps the speed here to reduce kicks
local SEARCH_RADIUS = 2000 -- how far to look for coins/eggs/candy
local ARRIVE_THRESHOLD = 3 -- how close to coin to consider "collected"
local AFK_CLICK_INTERVAL = 60 -- seconds
-- ===================

-- runtime state
local autofarmEnabled = false
local toFarm = "Egg" -- default: "Egg" | "Coin" | "Candy"
local autoFarmSpeed = AUTO_FARM_SPEED
local espEnabled = false
local espHighlighters = {} -- map player -> highlight

-- ===== Anti AFK =====
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)
task.spawn(function()
    while true do
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
        task.wait(AFK_CLICK_INTERVAL)
    end
end)

-- ===== Helpers =====
local function refreshCharacterRefs()
    Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
    Humanoid = Character:FindFirstChildOfClass("Humanoid") or Character:WaitForChild("Humanoid")
end

LocalPlayer.CharacterAdded:Connect(function(newChar)
    task.wait(0.1)
    refreshCharacterRefs()
end)

local function get_nearest_coin()
    -- Scans workspace for objects with a CoinContainer child and searches inside for coin objects
    local closest, minDist = nil, math.huge
    for _, model in ipairs(workspace:GetChildren()) do
        if typeof(model) == "Instance" and model:FindFirstChild("CoinContainer") then
            for _, coin in ipairs(model.CoinContainer:GetChildren()) do
                if coin and coin:IsA("BasePart") and coin:GetAttribute("CoinID") == toFarm and coin:FindFirstChild("TouchInterest") then
                    local dist = (HumanoidRootPart.Position - coin.Position).Magnitude
                    if dist < minDist and dist <= SEARCH_RADIUS then
                        minDist = dist
                        closest = coin
                    end
                end
            end
        end
    end
    return closest, minDist
end

local function tween_to_cframe(targetCFrame, duration)
    if not HumanoidRootPart or not HumanoidRootPart.Parent then return nil end
    local tween = TweenService:Create(HumanoidRootPart, TweenInfo.new(duration, Enum.EasingStyle.Linear), {CFrame = targetCFrame})
    tween:Play()
    return tween
end

-- Wait until touchinterest disappears (best-effort)
local function wait_until_collected(coin, timeout)
    timeout = timeout or 5
    local t0 = tick()
    while tick() - t0 < timeout do
        if not coin or not coin.Parent then
            return true
        end
        if not coin:FindFirstChild("TouchInterest") then
            return true
        end
        task.wait(0.1)
    end
    return false
end

-- ===== Autofarm loop =====
local farmingThread
local function start_farm_loop()
    if farmingThread and farmingThread.Connected then return end
    farmingThread = RunService.Heartbeat:Connect(function()
        if not autofarmEnabled then return end
        if not HumanoidRootPart or not HumanoidRootPart.Parent then return end

        local coin, dist = get_nearest_coin()
        if coin then
            -- Conservative movement: if far, teleport near it; if near, tween slowly
            if dist > 150 then
                -- set directly near (snap near but not inside)
                local offset = Vector3.new(0, 3, 0)
                HumanoidRootPart.CFrame = coin.CFrame + offset
                task.wait(0.2)
                wait_until_collected(coin, 4)
            else
                local duration = math.max(0.1, dist / math.clamp(autoFarmSpeed, 5, MAX_SAFE_SPEED))
                local tween = tween_to_cframe(coin.CFrame + Vector3.new(0,3,0), duration)
                -- wait until coin no longer has TouchInterest or farming disabled
                local collected = wait_until_collected(coin, duration + 1)
                if tween then tween:Cancel() end
                task.wait(0.15)
            end
        end
    end)
end

local function stop_farm_loop()
    if farmingThread then
        farmingThread:Disconnect()
        farmingThread = nil
    end
end

-- ===== Simple ESP (local-only) =====
local function add_highlight_to_player(player)
    if not player.Character then return end
    if espHighlighters[player] then return end
    local highlight = Instance.new("Highlight")
    highlight.Name = "SafeESP"
    highlight.Parent = player.Character
    highlight.Adornee = player.Character
    highlight.FillTransparency = 0.6
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    espHighlighters[player] = highlight
end

local function remove_highlight_from_player(player)
    local h = espHighlighters[player]
    if h and h.Parent then
        h:Destroy()
    end
    espHighlighters[player] = nil
end

local function refresh_esp_all()
    -- Clear existing
    for p, _ in pairs(espHighlighters) do
        remove_highlight_from_player(p)
    end
    if not espEnabled then return end
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            add_highlight_to_player(p)
        end
    end
end

Players.PlayerAdded:Connect(function(p)
    if espEnabled and p ~= LocalPlayer then
        p.CharacterAdded:Connect(function() add_highlight_to_player(p) end)
    end
end)
Players.PlayerRemoving:Connect(function(p) remove_highlight_from_player(p) end)

-- ===== Simple GUI =====
local CoreGui = game:GetService("CoreGui") -- if running under exploit, otherwise use PlayerGui
local playerGui = LocalPlayer:FindFirstChildOfClass("PlayerGui") or LocalPlayer:WaitForChild("PlayerGui")

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SafeToolHub"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "Main"
mainFrame.AnchorPoint = Vector2.new(0,0)
mainFrame.Position = UDim2.new(0.02, 0, 0.12, 0)
mainFrame.Size = UDim2.new(0, 360, 0, 380)
mainFrame.BackgroundTransparency = 0.2
mainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

local title = Instance.new("TextLabel", mainFrame)
title.Text = "Safe Tool Hub (Local-only)"
title.Size = UDim2.new(1,0,0,28)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.GothamBold
title.TextSize = 18

-- Basic helper for making buttons
local function makeButton(parent, text, posY, callback)
    local b = Instance.new("TextButton", parent)
    b.Size = UDim2.new(0, 160, 0, 28)
    b.Position = UDim2.new(0, 12 + ((#parent:GetChildren()-2)%2)*170, 0, posY)
    b.BackgroundColor3 = Color3.fromRGB(50,50,50)
    b.TextColor3 = Color3.new(1,1,1)
    b.Text = text
    b.Font = Enum.Font.Gotham
    b.TextSize = 14
    b.MouseButton1Click:Connect(callback)
    return b
end

-- Toggle Buttons and sliders
local farmToggle = makeButton(mainFrame, "Enable Autofarm: OFF", 40, function()
    autofarmEnabled = not autofarmEnabled
    farmToggle.Text = "Enable Autofarm: " .. (autofarmEnabled and "ON" or "OFF")
    if autofarmEnabled then start_farm_loop() else stop_farm_loop() end
end)

local farmTypeLabel = Instance.new("TextLabel", mainFrame)
farmTypeLabel.Position = UDim2.new(0,12,0,80)
farmTypeLabel.Size = UDim2.new(0,336,0,20)
farmTypeLabel.Text = "Farm Type: " .. toFarm
farmTypeLabel.BackgroundTransparency = 1
farmTypeLabel.TextColor3 = Color3.new(1,1,1)
farmTypeLabel.Font = Enum.Font.Gotham
farmTypeLabel.TextSize = 14

local typeButtonsY = 105
local eggBtn = makeButton(mainFrame, "Egg", typeButtonsY, function() toFarm = "Egg"; farmTypeLabel.Text = "Farm Type: " .. toFarm end)
local coinBtn = makeButton(mainFrame, "Coin", typeButtonsY, function() toFarm = "Coin"; farmTypeLabel.Text = "Farm Type: " .. toFarm end)
local candyBtn = makeButton(mainFrame, "Candy", typeButtonsY, function() toFarm = "Candy"; farmTypeLabel.Text = "Farm Type: " .. toFarm end)

-- Speed slider (simple)
local speedLabel = Instance.new("TextLabel", mainFrame)
speedLabel.Position = UDim2.new(0,12,0,155)
speedLabel.Size = UDim2.new(0,336,0,20)
speedLabel.Text = "AutoFarm Speed: " .. tostring(autoFarmSpeed)
speedLabel.BackgroundTransparency = 1
speedLabel.TextColor3 = Color3.new(1,1,1)
speedLabel.Font = Enum.Font.Gotham
speedLabel.TextSize = 14

local speedDecrease = makeButton(mainFrame, "-", 180, function()
    autoFarmSpeed = math.max(5, autoFarmSpeed - 1)
    speedLabel.Text = "AutoFarm Speed: " .. tostring(autoFarmSpeed)
end)
local speedIncrease = makeButton(mainFrame, "+", 180, function()
    autoFarmSpeed = math.min(MAX_SAFE_SPEED, autoFarmSpeed + 1)
    speedLabel.Text = "AutoFarm Speed: " .. tostring(autoFarmSpeed)
end)

local speedApplyBtn = makeButton(mainFrame, "Apply Speed", 220, function()
    -- no server calls; just updates local var used by tween
    WindWarn = false
    speedLabel.Text = "AutoFarm Speed: " .. tostring(autoFarmSpeed) .. " (applied)"
end)

-- Speed & Jump client controls
local walkLabel = Instance.new("TextLabel", mainFrame)
walkLabel.Position = UDim2.new(0,12,0,260)
walkLabel.Size = UDim2.new(0,160,0,18)
walkLabel.Text = "WalkSpeed: " .. tostring(Humanoid.WalkSpeed)
walkLabel.BackgroundTransparency = 1
walkLabel.TextColor3 = Color3.new(1,1,1)
walkLabel.Font = Enum.Font.Gotham
walkLabel.TextSize = 14

local jumpLabel = Instance.new("TextLabel", mainFrame)
jumpLabel.Position = UDim2.new(0,188,0,260)
jumpLabel.Size = UDim2.new(0,160,0,18)
jumpLabel.Text = "JumpPower: " .. tostring(Humanoid.JumpPower)
jumpLabel.BackgroundTransparency = 1
jumpLabel.TextColor3 = Color3.new(1,1,1)
jumpLabel.Font = Enum.Font.Gotham
jumpLabel.TextSize = 14

local incWalk = makeButton(mainFrame, "Walk +", 285, function()
    if Humanoid and Humanoid.Parent then
        Humanoid.WalkSpeed = math.min(500, Humanoid.WalkSpeed + 2)
        walkLabel.Text = "WalkSpeed: " .. tostring(Humanoid.WalkSpeed)
    end
end)
local decWalk = makeButton(mainFrame, "Walk -", 285, function()
    if Humanoid and Human
